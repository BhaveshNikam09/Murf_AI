<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Conversational AI Agent</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <h2>Conversational AI Agent</h2>
    <div class="container">
        <select id="llmVoiceSelect">
            <option value="en-US-charles">en-US-charles (US Male)</option>
            <option value="en-US-lucy">en-US-lucy (US Female)</option>
            <option value="en-UK-george">en-UK-george (UK Male)</option>
        </select>
        <button id="recordBtn" class="record-btn">üéô Start Recording</button>
        <p id="llmUploadStatus"></p>

        <p><strong>Your Question:</strong></p>
        <p id="llmTranscriptResult">[Transcript will appear here]</p>
        <p><strong>LLM Reply:</strong></p>
        <p id="llmTextReply">[Reply will appear here]</p>
        <audio id="llmMurfPlayback" controls style="display:none;"></audio>

        <h3>Chat History</h3>
        <div id="chatHistory"></div>
    </div>

    <script>
        let llmMediaRecorder, llmAudioChunks = [];
        let isRecording = false;
        const recordBtn = document.getElementById("recordBtn");
        const llmUploadStatus = document.getElementById("llmUploadStatus");
        const llmTranscriptResult = document.getElementById("llmTranscriptResult");
        const llmTextReply = document.getElementById("llmTextReply");
        const llmMurfPlayback = document.getElementById("llmMurfPlayback");
        const chatHistoryDiv = document.getElementById("chatHistory");

        function updateChatHistory(history) {
            chatHistoryDiv.innerHTML = "";
            history.forEach(entry => {
                chatHistoryDiv.innerHTML += `<div class="chat-user">You: ${entry.user}</div>
                                             <div class="chat-bot">Bot: ${entry.bot}</div>`;
            });
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        recordBtn.addEventListener("click", async () => {
            if (!isRecording) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                llmMediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                llmAudioChunks = [];
                llmMediaRecorder.ondataavailable = e => { if (e.data.size > 0) llmAudioChunks.push(e.data); };
                llmMediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(llmAudioChunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append("file", audioBlob, "query.webm");
                    formData.append("voiceId", document.getElementById("llmVoiceSelect").value);
                    llmUploadStatus.textContent = "Processing...";
                    try {
                        const res = await fetch("/llm/query", { method: "POST", body: formData });
                        const data = await res.json();
                        if (data.transcript && data.llm_reply) {
                            llmTranscriptResult.textContent = data.transcript;
                            llmTextReply.textContent = data.llm_reply;
                            llmMurfPlayback.src = data.murf_audio_url;
                            llmMurfPlayback.style.display = "block";
                            llmMurfPlayback.play();
                            updateChatHistory(data.history);
                            llmUploadStatus.textContent = "Done!";
                        } else {
                            llmUploadStatus.textContent = "Error: Could not process.";
                            llmMurfPlayback.src = "/static/fallback.mp3";
                            llmMurfPlayback.style.display = "block";
                            llmMurfPlayback.play();
                        }
                    } catch (err) {
                        llmUploadStatus.textContent = "Error: Connection failed.";
                    }
                };
                llmMediaRecorder.start();
                recordBtn.textContent = "‚èπ Stop Recording";
                recordBtn.classList.add("recording");
                isRecording = true;
            } else {
                llmMediaRecorder.stop();
                recordBtn.textContent = "üéô Start Recording";
                recordBtn.classList.remove("recording");
                isRecording = false;
            }
        });
    </script>
</body>
</html>
