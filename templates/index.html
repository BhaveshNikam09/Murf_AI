<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LLM Voice Bot</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>🤖 LLM Voice Bot</h2>
        </div>

        <div class="chat-history" id="chat-history">
            {% for msg in chat_history %}
                <div class="message {{ 'user' if msg.role == 'user' else 'bot' }}">
                    <div class="bubble">{{ msg.content }}</div>
                </div>
            {% endfor %}
        </div>

        <div class="chat-input">
            <form id="chat-form" enctype="multipart/form-data">
                <input type="text" id="text-input" name="text_input" placeholder="Type your message..." autocomplete="off">
                <button type="button" id="mic-btn">🎤</button>
                <button type="submit">Send</button>
            </form>
        </div>
    </div>

    <audio id="ai-audio" controls hidden></audio>

    <script>
        const chatForm = document.getElementById("chat-form");
        const chatHistory = document.getElementById("chat-history");
        const micBtn = document.getElementById("mic-btn");
        const aiAudio = document.getElementById("ai-audio");

        let mediaRecorder;
        let audioChunks = [];

        // Handle form submission (text input)
        chatForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const text = document.getElementById("text-input").value;
            if (!text.trim()) return;

            addMessage("user", text);
            document.getElementById("text-input").value = "";

            const formData = new FormData();
            formData.append("text_input", text);

            const res = await fetch("/chat", {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            addMessage("bot", data.ai_reply);

            aiAudio.src = "/" + data.audio_path;
            aiAudio.hidden = false;
            aiAudio.play();
        });

        // Mic button (audio recording)
        micBtn.addEventListener("click", async () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                startRecording();
            } else {
                stopRecording();
            }
        });

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];
                micBtn.textContent = "⏹️";

                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                    sendAudio(audioBlob);
                    micBtn.textContent = "🎤";
                });
            });
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
        }

        async function sendAudio(blob) {
            const formData = new FormData();
            formData.append("audio", blob, "query.webm");

            const res = await fetch("/chat", {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            addMessage("user", data.user_text);
            addMessage("bot", data.ai_reply);

            aiAudio.src = "/" + data.audio_path;
            aiAudio.hidden = false;
            aiAudio.play();
        }

        function addMessage(role, text) {
            const message = document.createElement("div");
            message.classList.add("message", role);

            const bubble = document.createElement("div");
            bubble.classList.add("bubble");
            bubble.textContent = text;

            message.appendChild(bubble);
            chatHistory.appendChild(message);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    </script>
</body>
</html>
